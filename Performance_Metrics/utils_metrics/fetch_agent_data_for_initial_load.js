// Agent data from the provided object
// const agent = {
//   "agentBasicDetails": {
//     "agentId": "AGT-324d270d4718aa14",
//     "agentName": "meenkshi",
//     "availableTokens": 500,
//     "companyDescription": "Providing top-notch customer support for all your needs.",
//     "companyEmail": "meenu@gmail.com",
//     "companyHumanServiceNumber": "9183421044",
//     "companyName": "aman",
//     "companyOwnerName": "rahul rastogi",
//     "establishmentDate": "2025-08-08T00:00:00.000Z",
//     "lastModified": "2025-08-21T18:30:15.123Z",
//     "username": "aman1234",
//     "items": [
//       {
//         "itemName": "Laptop Support",
//         "itemCode": "LAP-001",
//         "itemInitialWorkingExplanation": "Assists with common laptop issues like slow performance, software crashes, and connectivity problems.",
//         "itemRunningSteps": [
//           "Check for system updates.",
//           "Run a diagnostic scan.",
//           "Clear temporary files."
//         ],
//         "commonProblemsSolutions": [
//           {
//             "problem": "Laptop is running slow.",
//             "solution": "Close unnecessary applications and clear temporary files."
//           },
//           {
//             "problem": "Wi-Fi is not connecting.",
//             "solution": "Restart the Wi-Fi router and the laptop."
//           }
//         ]
//       },
//       {
//         "itemName": "Mobile Phone Troubleshooting",
//         "itemCode": "MOB-002",
//         "itemInitialWorkingExplanation": "Provides solutions for mobile phone issues such as battery drain, app errors, and screen freezing.",
//         "itemRunningSteps": [
//           "Restart the device.",
//           "Check for app updates.",
//           "Perform a factory reset if necessary."
//         ],
//         "commonProblemsSolutions": [
//           {
//             "problem": "Phone battery is draining quickly.",
//             "solution": "Check background app usage and reduce screen brightness."
//           },
//           {
//             "problem": "An app is crashing repeatedly.",
//             "solution": "Clear the app's cache and data or reinstall the app."
//           }
//         ]
//       }
//     ],
//     "modificationHistory": [
//       {
//         "timestamp": "2025-08-20T20:24:54.245Z",
//         "items": [],
//         "companyName": "aman",
//         "establishmentDate": "2025-08-08T00:00:00.000Z",
//         "companyOwnerName": "rahul rastogi",
//         "companyHumanServiceNumber": "9183421044",
//         "companyEmail": "meenu@gmail.com",
//         "companyDescription": "vfadfgavd"
//       },
//       {
//         "timestamp": "2025-08-21T18:30:15.123Z",
//         "items": [
//           {
//             "itemName": "Laptop Support",
//             "itemCode": "LAP-001"
//           },
//           {
//             "itemName": "Mobile Phone Troubleshooting",
//             "itemCode": "MOB-002"
//           }
//         ],
//         "companyName": "aman",
//         "establishmentDate": "2025-08-08T00:00:00.000Z",
//         "companyOwnerName": "rahul rastogi",
//         "companyHumanServiceNumber": "9183421044",
//         "companyEmail": "meenu@gmail.com",
//         "companyDescription": "Providing top-notch customer support for all your needs."
//       }
//     ]
//   },
//   "customerReviews": [
//     {
//       "username": "User123",
//       "comment": "Very helpful and quick response! Solved my issue in minutes.",
//       "reviewStar": 5,
//       "timestamp": "2025-08-21T15:00:00.000Z"
//     },
//     {
//       "username": "HappyCustomer",
//       "comment": "The agent was knowledgeable and guided me through the steps perfectly.",
//       "reviewStar": 5,
//       "timestamp": "2025-08-21T16:30:00.000Z"
//     },
//     {
//       "username": "TechNovice",
//       "comment": "I had a hard time following the instructions, but the problem was eventually solved.",
//       "reviewStar": 3,
//       "timestamp": "2025-08-21T17:45:00.000Z"
//     }
//   ],
//   "requestHandledLogs": [
//     {
//       "timestamp": "2025-08-21T15:00:00.000Z"
//     },
//     {
//       "timestamp": "2025-08-21T16:30:00.000Z"
//     },
//     {
//       "timestamp": "2025-08-21T17:45:00.000Z"
//     },
//     {
//       "timestamp": "2025-08-21T18:05:00.000Z"
//     },
//     {
//       "timestamp": "2025-08-21T18:35:00.000Z"
//     },
//     {
//       "timestamp": "2025-08-20T09:15:00.000Z"
//     },
//     {
//       "timestamp": "2025-08-20T14:20:00.000Z"
//     },
//     {
//       "timestamp": "2025-08-20T16:45:00.000Z"
//     },
//     {
//       "timestamp": "2025-08-19T11:30:00.000Z"
//     },
//     {
//       "timestamp": "2025-08-19T15:20:00.000Z"
//     },
//     {
//       "timestamp": "2025-08-18T10:10:00.000Z"
//     },
//     {
//       "timestamp": "2025-08-17T13:40:00.000Z"
//     },
//     {
//       "timestamp": "2025-08-17T16:15:00.000Z"
//     },
//     {
//       "timestamp": "2025-08-16T12:25:00.000Z"
//     },
//     {
//       "timestamp": "2025-08-15T14:50:00.000Z"
//     }
//   ],
//   "satisfactionRate": 4.3,
//   "satisfactionRateLogs": [
//     {
//       "reviewStar": 5,
//       "timestamp": "2025-08-21T15:00:00.000Z"
//     },
//     {
//       "reviewStar": 5,
//       "timestamp": "2025-08-21T16:30:00.000Z"
//     },
//     {
//       "reviewStar": 3,
//       "timestamp": "2025-08-21T17:45:00.000Z"
//     }
//   ],
//   "totalRequestsHandled": 15,
//   "usageLogs": [
//     {
//       "tokensUsed": 150,
//       "timestamp": "2025-08-21T15:00:00.000Z"
//     },
//     {
//       "tokensUsed": 200,
//       "timestamp": "2025-08-21T16:30:00.000Z"
//     },
//     {
//       "tokensUsed": 80,
//       "timestamp": "2025-08-21T17:45:00.000Z"
//     },{
//       "tokensUsed": 150,
//       "timestamp": "2025-09-21T15:00:00.000Z"
//     },
//     {
//       "tokensUsed": 200,
//       "timestamp": "2025-09-21T16:30:00.000Z"
//     },{
//       "tokensUsed": 150,
//       "timestamp": "2025-10-21T15:00:00.000Z"
//     },
//     {
//       "tokensUsed": 20,
//       "timestamp": "2025-10-21T16:30:00.000Z"
//     },
//     {
//       "tokensUsed": 200,
//       "timestamp": "2025-12-21T16:30:00.000Z"
//     },
//   ]
// };

// load agent data from server

// utils/agentIndexedDB.js

// Performance_Metrics/utils_metrics/fetch_agent_data_for_initial_load.js

// âœ… Function to open IndexedDB
function openAgentDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("PerformanceMetricsDB", 1);

    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains("agents")) {
        db.createObjectStore("agents", { keyPath: "agentId" });
      }
    };

    request.onsuccess = (event) => {
      resolve(event.target.result);
    };

    request.onerror = (event) => {
      reject("IndexedDB error: " + event.target.errorCode);
    };
  });
}

// âœ… Function to save agent in IndexedDB
async function saveAgentToDB(agent) {
  const db = await openAgentDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction("agents", "readwrite");
    const store = tx.objectStore("agents");
    const request = store.put(agent); // âœ… keyPath = agentId ensures unique

    request.onsuccess = () => resolve(agent);
    request.onerror = (event) => reject("Save error: " + event.target.errorCode);
  });
}

// âœ… Main function
async function fetchAgentDataForInitialLoad() {
  try {
    // 1. Get agentId from URL query params
    const urlParams = new URLSearchParams(window.location.search);
    const agentId = urlParams.get("agentId");

    if (!agentId) {
      throw new Error("agentId is required in URL query params");
    }

    // 2. Make POST request with credentials
    const response = await fetch(`/performance_metrics/all`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      credentials: "include", // ðŸ‘ˆ for cookies (JWT)
      body: JSON.stringify({ agentId }), // âœ… sending agentId in request body
    });

    if (!response.ok) {
      throw new Error(`Server error: ${response.status}`);
    }

    const agents = await response.json(); // âœ… single agent object
    console.log("Fetched agent from API:", agents);

    // Create proper object to save
    const agentToSave = { ...agents, agentId: agents.agentBasicDetails.agentId };

    // 3. Save into IndexedDB
    await saveAgentToDB(agentToSave);

    // 4. Return the saved agent object
    return agentToSave;

  } catch (err) {
    console.error("Error fetching agent:", err);
    throw err;
  }
}


// Auto-run for initial load
(async () => {
  const agents = await fetchAgentDataForInitialLoad();
  console.log("Agent data stored in IndexedDB:", agents);
})();

